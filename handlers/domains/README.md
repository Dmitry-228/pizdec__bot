# Доменная архитектура хендлеров

## Обзор

Новая архитектура основана на принципах Domain-Driven Design (DDD) и разделяет функциональность бота на логические домены. Каждый домен отвечает за определенную область бизнес-логики и содержит все необходимые компоненты для работы.

## Структура доменов

```
handlers/domains/
├── common/                 # Общие компоненты
│   ├── __init__.py
│   ├── base.py            # Базовые классы хендлеров
│   ├── types.py           # Типы данных
│   ├── exceptions.py      # Исключения
│   └── decorators.py      # Декораторы
├── auth/                  # Аутентификация и регистрация
│   ├── __init__.py
│   ├── handlers.py        # Основной хендлер домена
│   ├── commands.py        # Команды (/start, /help)
│   └── callbacks.py       # Callback обработчики
├── payments/              # Платежи и подписки
│   ├── __init__.py
│   ├── handlers.py
│   ├── callbacks.py
│   ├── webhooks.py        # Webhook обработчики
│   └── services.py        # Бизнес-логика платежей
├── generation/            # Генерация контента
│   ├── __init__.py
│   ├── handlers.py
│   ├── callbacks.py
│   ├── messages.py        # Обработка текста и изображений
│   └── services.py        # Логика генерации
├── user/                  # Пользовательский профиль
│   ├── __init__.py
│   ├── handlers.py
│   ├── callbacks.py
│   └── services.py        # Управление профилем
├── admin/                 # Административные функции
│   ├── __init__.py
│   ├── handlers.py
│   ├── callbacks.py
│   └── services.py        # Админские операции
├── broadcast/             # Рассылки и уведомления
│   ├── __init__.py
│   ├── handlers.py
│   ├── callbacks.py
│   ├── scheduler.py       # Планировщик рассылок
│   └── services.py        # Логика рассылок
└── registry.py            # Центральный реестр доменов
```

## Принципы архитектуры

### 1. Разделение ответственности
- Каждый домен отвечает только за свою область
- Хендлеры разделены по типам (команды, callback'и, сообщения)
- Бизнес-логика вынесена в сервисы

### 2. Единообразие
- Все хендлеры наследуются от базовых классов
- Единый подход к обработке ошибок
- Стандартизированные типы возвращаемых значений

### 3. Переиспользование
- Общие компоненты в папке `common/`
- Декораторы для типовых проверок
- Базовые классы с общей функциональностью

### 4. Тестируемость
- Четкое разделение логики и представления
- Инъекция зависимостей через конструкторы
- Изолированные компоненты

## Базовые классы

### BaseHandler
Базовый класс для всех хендлеров с общей функциональностью:
- Безопасная отправка сообщений
- Обработка ошибок
- Логирование

### BaseCallbackHandler
Специализированный класс для callback обработчиков:
- Автоматический ответ на callback query
- Стандартизированная обработка ошибок

### BaseMessageHandler
Специализированный класс для обработчиков сообщений:
- Обработка различных типов сообщений
- Валидация входных данных

### BaseDomainHandler
Основной класс домена с маршрутизацией:
- Регистрация хендлеров
- Маршрутизация по паттернам
- Управление состоянием

## Декораторы

### @admin_required
Проверяет права администратора перед выполнением функции.

### @user_required
Проверяет существование пользователя в базе данных.

### @check_resources(photos=N, avatars=M)
Проверяет достаточность ресурсов пользователя.

### @with_user_context
Добавляет контекст пользователя в аргументы функции.

### @log_handler_call
Логирует вызовы хендлеров для отладки.

## Типы данных

### HandlerResult
Стандартизированный результат выполнения хендлера сообщений.

### CallbackResult
Стандартизированный результат выполнения callback хендлера.

### UserContext
Контекст пользователя с основной информацией.

## Исключения

Иерархия исключений для различных типов ошибок:
- `HandlerError` - базовое исключение
- `ValidationError` - ошибки валидации
- `PermissionError` - ошибки прав доступа
- `ResourceError` - недостаток ресурсов
- `GenerationError` - ошибки генерации
- `PaymentError` - ошибки платежей

## Реестр доменов

`DomainRegistry` - центральная точка управления всеми доменами:
- Инициализация всех доменов
- Маршрутизация запросов к соответствующим доменам
- Создание единого роутера для aiogram

## Преимущества новой архитектуры

### 1. Читаемость
- Четкая структура по доменам
- Небольшие, сфокусированные файлы
- Понятные имена и ответственности

### 2. Поддерживаемость
- Легко найти нужный код
- Изменения в одном домене не влияют на другие
- Простое добавление новой функциональности

### 3. Тестируемость
- Изолированные компоненты
- Четкие интерфейсы
- Возможность мокирования зависимостей

### 4. Масштабируемость
- Легко добавлять новые домены
- Возможность разделения на микросервисы
- Параллельная разработка разных доменов

## Миграция

### Этап 1: Подготовка
1. Создание новой структуры доменов
2. Реализация базовых классов и общих компонентов
3. Создание реестра доменов

### Этап 2: Миграция по доменам
1. **Auth домен** - команды /start, /help, реферальная система
2. **Payments домен** - тарифы, платежи, webhook'и
3. **Generation домен** - генерация фото, видео, аватаров
4. **User домен** - профиль, настройки, управление аватарами
5. **Admin домен** - административные функции
6. **Broadcast домен** - рассылки и уведомления

### Этап 3: Интеграция
1. Обновление main.py для использования нового реестра
2. Тестирование всех функций
3. Постепенное удаление старых файлов

### Этап 4: Оптимизация
1. Рефакторинг дублирующегося кода
2. Оптимизация производительности
3. Добавление дополнительных тестов

## Пример использования

```python
# Создание нового хендлера
class MyCallbackHandler(BaseCallbackHandler):
    @log_handler_call
    @user_required
    async def handle(self, query: CallbackQuery, state: FSMContext) -> CallbackResult:
        user_id = query.from_user.id
        
        # Бизнес-логика
        result = await some_service.do_something(user_id)
        
        # Отправка ответа
        await self.send_safe_message(user_id, "Операция выполнена!")
        
        return CallbackResult.success_result("Успешно выполнено")

# Регистрация в домене
class MyDomainHandler(BaseDomainHandler):
    def __init__(self, bot: Bot):
        super().__init__(bot)
        self.register_callback("my_action_", MyCallbackHandler(bot))
```

## Заключение

Новая доменная архитектура значительно улучшает структуру проекта, делая его более читаемым, поддерживаемым и масштабируемым. Переход на новую архитектуру позволит команде разработчиков работать более эффективно и быстро добавлять новую функциональность.