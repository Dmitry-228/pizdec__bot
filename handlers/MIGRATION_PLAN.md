# План миграции к доменной архитектуре

## Текущие проблемы

### Анализ существующих файлов:

1. **callbacks_user.py** (3136 строк) - монолитный файл со смешанными обязанностями
2. **broadcast.py** (1685 строк) - рассылки + миграции БД + планировщик
3. **messages.py** (1069 строк) - разные типы сообщений в одном файле
4. **commands.py** (725 строк) - команды + бизнес-логика
5. **callbacks_admin.py** (701 строк) - админские функции + генерация
6. **admin_panel.py** (503 строк) - админка + статистика + отчеты
7. **utils.py** (683 строк) - утилиты + бизнес-логика + форматирование

### Основные проблемы:
- Нарушение принципа единственной ответственности
- Сложные зависимости и циклические импорты
- Дублирование кода
- Сложность тестирования и поддержки
- Монолитные функции (например, `handle_user_callback` на 3000+ строк)

## Этапы миграции

### Этап 1: Создание инфраструктуры ✅
- [x] Создана папка `handlers/domains/`
- [x] Реализованы базовые классы в `common/`
- [x] Созданы типы данных и исключения
- [x] Реализованы декораторы для типовых проверок
- [x] Создан центральный реестр доменов

### Этап 2: Миграция домена аутентификации ✅
- [x] Создан домен `auth/`
- [x] Перенесены команды `/start`, `/help`
- [x] Реализована реферальная система
- [x] Добавлено управление главным меню

### Этап 3: Миграция домена платежей (В процессе)
- [x] Создан домен `payments/`
- [x] Реализованы сервисы для работы с тарифами
- [x] Создан сервис платежей
- [ ] Перенести callback'и тарифов из `callbacks_user.py`
- [ ] Перенести webhook обработчики
- [ ] Реализовать обработку успешных платежей

### Этап 4: Миграция домена генерации
- [ ] Создать домен `generation/`
- [ ] Перенести логику генерации фото из `callbacks_user.py`
- [ ] Перенести обработку стилей и промптов
- [ ] Реализовать сервисы генерации
- [ ] Перенести обработку изображений из `messages.py`

### Этап 5: Миграция пользовательского домена
- [ ] Создать домен `user/`
- [ ] Перенести управление профилем
- [ ] Перенести управление аватарами
- [ ] Реализовать настройки пользователя

### Этап 6: Миграция административного домена
- [ ] Создать домен `admin/`
- [ ] Перенести функции из `admin_panel.py`
- [ ] Перенести callback'и из `callbacks_admin.py`
- [ ] Реализовать управление пользователями
- [ ] Перенести генерацию отчетов

### Этап 7: Миграция домена рассылок
- [ ] Создать домен `broadcast/`
- [ ] Перенести логику из `broadcast.py`
- [ ] Реализовать планировщик рассылок
- [ ] Перенести миграции БД в отдельный модуль

### Этап 8: Рефакторинг утилит
- [ ] Разделить `utils.py` по доменам
- [ ] Оставить только общие утилиты в `common/`
- [ ] Перенести доменную логику в соответствующие сервисы

### Этап 9: Обновление main.py
- [ ] Заменить множественные импорты на `DomainRegistry`
- [ ] Упростить инициализацию бота
- [ ] Удалить старые роутеры

### Этап 10: Тестирование и очистка
- [ ] Протестировать все функции
- [ ] Удалить старые файлы
- [ ] Обновить документацию

## Детальный план по файлам

### callbacks_user.py → Разделение по доменам

**Функция `handle_user_callback` (строки 1-500+):**
```python
# Текущий код - одна огромная функция
async def handle_user_callback(query: CallbackQuery, state: FSMContext):
    # 3000+ строк кода со всеми возможными callback'ами
```

**Новая структура:**
```python
# payments/callbacks.py
class TariffCallbackHandler(BaseCallbackHandler):
    async def handle(self, query: CallbackQuery, state: FSMContext):
        # Только логика тарифов

# generation/callbacks.py  
class StyleCallbackHandler(BaseCallbackHandler):
    async def handle(self, query: CallbackQuery, state: FSMContext):
        # Только логика стилей

# user/callbacks.py
class AvatarCallbackHandler(BaseCallbackHandler):
    async def handle(self, query: CallbackQuery, state: FSMContext):
        # Только логика аватаров
```

### messages.py → Разделение по типам

**Текущие проблемы:**
- Обработка текста, фото, видео в одном файле
- Смешение логики генерации и платежей
- Дублирование проверок ресурсов

**Новая структура:**
```python
# generation/messages.py
class PromptMessageHandler(BaseMessageHandler):
    @check_resources(photos=1)
    async def handle(self, message: Message, state: FSMContext):
        # Только обработка промптов

class ImageMessageHandler(BaseMessageHandler):
    @check_resources(photos=1)
    async def handle(self, message: Message, state: FSMContext):
        # Только обработка изображений
```

### broadcast.py → Разделение ответственности

**Текущие проблемы:**
- Рассылки + миграции БД + планировщик в одном файле
- 1685 строк смешанной логики

**Новая структура:**
```python
# broadcast/services.py - бизнес-логика рассылок
# broadcast/scheduler.py - планировщик
# broadcast/migrations.py - миграции БД
# broadcast/handlers.py - основные хендлеры
```

## Преимущества после миграции

### До миграции:
```python
# main.py - 1152 строки с множественными импортами
from handlers.commands import start, menu, help_command, debug_avatars
from handlers.messages import handle_text_message, handle_photo_message, handle_video_message
from handlers.callbacks_user import handle_user_callback
from handlers.callbacks_admin import handle_admin_callback
from handlers.broadcast import initiate_broadcast, broadcast_message_admin
from handlers.admin_panel import admin_panel, show_admin_stats
# ... еще 50+ импортов
```

### После миграции:
```python
# main.py - ~50 строк
from handlers.domains.registry import DomainRegistry

async def main():
    bot = Bot(token=BOT_TOKEN)
    dp = Dispatcher()
    
    registry = DomainRegistry(bot)
    dp.include_router(registry.create_router())
    
    await dp.start_polling(bot)
```

### Структура файлов:

**До:**
- 7 больших файлов (500-3000 строк каждый)
- Смешанные обязанности
- Сложные зависимости

**После:**
- 30+ небольших файлов (50-200 строк каждый)
- Четкое разделение ответственности
- Простые, понятные зависимости

## Критерии успеха

1. **Читаемость**: Каждый файл < 300 строк, четкая ответственность
2. **Поддерживаемость**: Легко найти и изменить нужную функциональность
3. **Тестируемость**: Возможность изолированного тестирования компонентов
4. **Производительность**: Не хуже текущей производительности
5. **Функциональность**: Все существующие функции работают корректно

## Риски и митигация

### Риск 1: Поломка существующей функциональности
**Митигация**: Поэтапная миграция с тестированием каждого этапа

### Риск 2: Увеличение сложности
**Митигация**: Подробная документация и примеры использования

### Риск 3: Производительность
**Митигация**: Профилирование до и после миграции

### Риск 4: Время разработки
**Митигация**: Параллельная работа над разными доменами

## Временные оценки

- **Этап 1-2**: ✅ Завершено (2 дня)
- **Этап 3**: 1 день (домен платежей)
- **Этап 4**: 2 дня (домен генерации - самый сложный)
- **Этап 5**: 1 день (пользовательский домен)
- **Этап 6**: 2 дня (административный домен)
- **Этап 7**: 1 день (домен рассылок)
- **Этап 8-10**: 1 день (финализация)

**Общее время**: ~10 рабочих дней

## Следующие шаги

1. Завершить миграцию домена платежей
2. Создать заглушки для остальных доменов
3. Начать поэтапную миграцию функций
4. Тестировать каждый этап
5. Обновить документацию

Эта миграция значительно улучшит качество кода и упростит дальнейшую разработку проекта.